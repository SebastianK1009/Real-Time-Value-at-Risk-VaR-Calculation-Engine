---
# Kubernetes Deployment - manages pod replicas
apiVersion: apps/v1
kind: Deployment
metadata:
  # Fixed name for standalone deployment
  name: market-data-simulator
  labels:
  # Gives the deployment a label for organization and querying (selection)
    app: market-data-simulator
spec:
  # Run 1 replica for cost optimization on small clusters
  replicas: 1
  # Any Pod with label app=market-data-simulator belongs to this Deployment
  selector:
    matchLabels:
      app: market-data-simulator
  # Pod template specification
  template:
    metadata:
      # Pod labels (must match selector above). Marks all pods created by this deployment with this label so that Deployment and Service can find them
      labels:
        app: market-data-simulator
    spec:
      containers:
        - name: market-data-simulator
          image: 480609332059.dkr.ecr.ap-southeast-1.amazonaws.com/market-data-simulator:latest
          imagePullPolicy: IfNotPresent
          ports:
            # TCP port configuration
            - name: tcp
              containerPort: 9999
              protocol: TCP
          env:
            - name: MARKET_DATA_HOST
              value: "0.0.0.0" # Listen on all interfaces
            - name: MARKET_DATA_PORT
              value: "9999" # TCP port number
          livenessProbe:
            tcpSocket:
              port: tcp
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            tcpSocket:
              port: tcp
            initialDelaySeconds: 5
            periodSeconds: 10 
          # Resource limits and requests
          resources:
            requests:
              cpu: 100m
              memory: 128Mi 
            limits:
              cpu: 500m 
              memory: 256Mi 

---
# Kubernetes Service
apiVersion: v1
kind: Service
metadata:
  name: market-data-simulator
  labels:
    app: market-data-simulator
spec:
  # ClusterIP = internal only (no external IP assigned)
  type: ClusterIP
  ports:
    - port: 9999 # Service port
      targetPort: tcp # Routes to container port named "tcp"
      protocol: TCP
      name: tcp
  # Send TCP traffic to all Pods with label app=market-data-simulator
  selector:
    app: market-data-simulator
